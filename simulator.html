<!DOCTYPE html>
<html>
<head>
    <title>Trade Simulator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-database.js"></script>
    <style>
        /* Basic CSS for the Simulator */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .stat, .button-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #ecf0f1;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        button:hover {
            background-color: #2980b9;
        }
        #end-day-message {
            padding: 15px;
            background-color: #f1c40f;
            color: #333;
            font-weight: bold;
            border-radius: 4px;
            margin-top: 20px;
            display: none; /* Initially hidden */
        }
        /* Modal for Leaderboard/Settings */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #leaderboard ul {
            list-style: none;
            padding: 0;
        }
        #leaderboard ul li {
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Trade Simulator</h1>
    <p>
        <button onclick="showModal('leaderboard-modal')">üèÜ Leaderboard</button>
        <button onclick="showModal('settings-modal')">‚öôÔ∏è Settings</button>
    </p>

    <div id="stats">
        <div class="stat">Cash: <span id="cash">$1000</span></div>
        <div class="stat">Shares: <span id="shares">0</span></div>
        <div class="stat">Market Price: <span id="market-price">$50</span></div>
        <div class="stat">üèÜ Highscore: <span id="highscore">$0</span></div>
    </div>

    <div class="button-group" id="trade-controls">
        <button onclick="buy(1000000)">Buy All</button>
        <button onclick="buy(1)">Buy 1</button>
        <button onclick="sell(1)">Sell 1</button>
        <button onclick="sell(1000000)">Sell All</button>
        <button onclick="nextTimeStep()">Next 30 Minutes</button>
    </div>
    
    <div id="end-day-message">
        Day Ended <br>
        Final Portfolio: <strong id="final-portfolio">$0</strong> <br>
        Profit/Loss: <span id="profit-loss">$0 (0%)</span> <br>
        Highscore: <strong id="new-highscore">$0</strong>
        <button onclick="continueTrading()">Continue Trading</button>
    </div>

</div>

<div id="leaderboard-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('leaderboard-modal')">&times;</span>
        <h2>üèÜ Leaderboard</h2>
        <div id="leaderboard">
            <ul>
                <li>Loading...</li>
            </ul>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('settings-modal')">&times;</span>
        <h2>‚öôÔ∏è Settings</h2>
        <p>Current Username: <strong id="current-username">Guest0000</strong></p>
        <label for="new-username-input">Change Username:</label><br>
        <input type="text" id="new-username-input" placeholder="Enter new username"><br><br>
        <button onclick="saveUsername()">Save Username</button>
        <button onclick="closeModal('settings-modal')">Cancel</button>
    </div>
</div>


<script>
    // --- FIREBASE CONFIGURATION (Provided by User) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAm-sSqxQ8PFO-k-h7VihWgoqNEyyCMOJY",
        authDomain: "stock-game-1.firebaseapp.com",
        projectId: "stock-game-1",
        storageBucket: "stock-game-1.firebasestorage.app",
        messagingSenderId: "267640665201",
        appId: "1:267640665201:web:8c339b723ab4d5a5a157d0",
        // The databaseURL is inferred from projectId for newer configs, 
        // but we'll include it explicitly for compatibility, matching the default pattern.
        databaseURL: "https://stock-game-1-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    // Database references
    var db = firebase.database();
    var dbRef = db.ref('leaderboard');
    
    // --- INITIAL VARIABLES ---
    var username = localStorage.getItem('simulatorUsername') || "Guest" + Math.floor(Math.random() * 10000);
    var cash = 1000.00;
    var shares = 0;
    var price = 50.00;
    var highscore = parseFloat(localStorage.getItem('simulatorHighscore')) || 0.00;
    var timeStep = 0; // Tracks the trading day progress (e.g., 0 to 8)
    var DAY_LENGTH = 8; // Number of trading steps in a day

    // --- NEW CODE BLOCK: FIREBASE RANK/TAG MANAGER (Start) ---

    // Storage for the ranks loaded from Firebase
    let globalUserRanks = {}; 

    // Global variable to hold the last fetched scores (for re-rendering)
    let latestScores = [];

    // Function to load ranks from the dedicated Firebase 'userRanks' node
    function loadUserRanks() {
        // Listen for changes on the 'userRanks' node
        db.ref('userRanks').on('value', function(snapshot) {
            if (snapshot.exists()) {
                // Update the global variable with the latest data
                globalUserRanks = snapshot.val();
                console.log("User ranks loaded from Firebase.", globalUserRanks);
                // Re-render the leaderboard with the new ranks if we have scores
                if (latestScores.length > 0) {
                    updateLeaderboard(latestScores); 
                }
            } else {
                console.log("No userRanks node found in Firebase. Please create the node in Firebase.");
            }
        });
    }

    // Function to retrieve a user's rank/tag from the loaded list
    function getUserRank(username) {
        // Look up the rank, defaulting to empty if not found.
        return globalUserRanks[username] || { label: "", color: "" };
    }

    // Call the rank loader function when the app loads
    loadUserRanks(); 

    // --- NEW CODE BLOCK: FIREBASE RANK/TAG MANAGER (End) ---
    

    // --- MAIN GAME LOGIC ---

    function updateDisplay() {
        $('#cash').text('$' + cash.toFixed(2));
        $('#shares').text(shares);
        $('#market-price').text('$' + price.toFixed(2));
        $('#highscore').text('$' + highscore.toFixed(2));
        $('#current-username').text(username);
    }

    function buy(amount) {
        let maxBuy = Math.floor(cash / price);
        let buyAmount = Math.min(amount, maxBuy);
        
        if (buyAmount > 0) {
            cash -= buyAmount * price;
            shares += buyAmount;
            updateDisplay();
        } else if (amount === 1000000) {
            alert("Not enough cash to buy any shares.");
        }
    }

    function sell(amount) {
        let sellAmount = Math.min(amount, shares);
        
        if (sellAmount > 0) {
            cash += sellAmount * price;
            shares -= sellAmount;
            updateDisplay();
        } else if (amount === 1000000) {
            alert("No shares to sell.");
        }
    }

    function calculatePortfolio() {
        return cash + (shares * price);
    }

    function nextTimeStep() {
        if (timeStep >= DAY_LENGTH) {
            endDay();
            return;
        }

        // Simulate market volatility
        let volatility = 0.05 * price; // 5% volatility
        let change = (Math.random() - 0.5) * 2 * volatility;
        price = Math.max(0.01, price + change); // Price never goes below 1 cent
        
        timeStep++;
        updateDisplay();

        if (timeStep >= DAY_LENGTH) {
            endDay();
        }
    }

    function endDay() {
        let finalPortfolio = calculatePortfolio();
        let initialValue = 1000.00;
        let profitLoss = finalPortfolio - initialValue;
        let percentChange = (profitLoss / initialValue) * 100;

        // Update Highscore
        if (finalPortfolio > highscore) {
            highscore = finalPortfolio;
            localStorage.setItem('simulatorHighscore', highscore.toFixed(2));
        }

        // Submit score to Firebase
        submitScore(username, finalPortfolio);

        // Update End Day Message
        $('#final-portfolio').text('$' + finalPortfolio.toFixed(2));
        $('#profit-loss').text('$' + profitLoss.toFixed(2) + ' (' + percentChange.toFixed(2) + '%)');
        $('#new-highscore').text('$' + highscore.toFixed(2));
        
        // Disable controls and show message
        $('#trade-controls button').prop('disabled', true);
        $('#end-day-message').show();
    }

    function continueTrading() {
        // Reset for a new day
        cash = 1000.00;
        shares = 0;
        price = 50.00;
        timeStep = 0;

        // Reset display
        $('#trade-controls button').prop('disabled', false);
        $('#end-day-message').hide();
        updateDisplay();
    }
    
    // --- FIREBASE LEADERBOARD FUNCTIONS ---

    function submitScore(username, score) {
        // Find the user's best score in the last 24 hours
        var cutoff = Date.now() - (24 * 60 * 60 * 1000); 

        // Query the leaderboard for the user's latest score
        dbRef.orderByChild('username').equalTo(username).limitToLast(1).once('value', function(snapshot) {
            let shouldUpdate = true;
            let existingKey = null;

            snapshot.forEach(function(childSnapshot) {
                const existingScore = childSnapshot.val();
                if (existingScore.score >= score) {
                    shouldUpdate = false; // Don't submit if the new score isn't better
                } else {
                    existingKey = childSnapshot.key; // Mark the old, lower score for deletion
                }
            });

            if (shouldUpdate) {
                // If a new high score is achieved, create the new record
                var newScore = {
                    username: username,
                    score: score,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                    // Tags are intentionally NOT saved here, they are looked up from 'userRanks'
                };
                
                // Save the new score
                dbRef.push(newScore).then(function() {
                    console.log("New high score submitted!");
                    
                    // If an old lower score was found, delete it to keep the leaderboard clean
                    if (existingKey) {
                        dbRef.child(existingKey).remove();
                    }
                });
            } else {
                console.log("Score not submitted: not a new high score for the user.");
            }
        });
    }


    function fetchLeaderboard() {
        // Fetch all scores, ordered by score descending, limited to top 50
        dbRef.orderByChild('score').limitToLast(50).once('value', function(snapshot) {
            var scores = [];
            snapshot.forEach(function (childSnapshot) {
                scores.push(childSnapshot.val());
            });
            
            // Reverse the array since orderByChild('score') sorts ascending by default
            scores.reverse(); 

            // Update the global latestScores variable and display the list
            updateLeaderboard(scores); 
        });
    }

    // --- MODIFIED FUNCTION TO DISPLAY RANKS ---
    function updateLeaderboard(scores) {
        var leaderboardList = $('#leaderboard ul');
        leaderboardList.empty(); 

        // Save the scores globally in case ranks update later
        latestScores = scores; 

        if (scores.length === 0) {
            leaderboardList.append('<li>No scores yet!</li>');
            return;
        }

        scores.forEach(function (score) {
            let tagHtml = '';
            
            // 1. LOOK UP THE RANK FROM THE FIREBASE-LOADED userRanks NODE
            const rankData = getUserRank(score.username);
            
            // 2. Check if a rank was found and it's not empty
            if (rankData.label && rankData.label.length > 0) {
                // Create a <span> for the custom tag with the specified color
                tagHtml = `<span style="font-weight: bold; color: ${rankData.color};">[${rankData.label}]</span> `;
            }
            
            // Assemble the final list item: [RANK] Username - $Score
            var listItem = `<li>${tagHtml}${score.username} - $${score.score.toFixed(2)}</li>`;
            leaderboardList.append(listItem);
        });
    }
    // --- END MODIFIED FUNCTION ---


    // --- UTILITY/MODAL FUNCTIONS ---

    function saveUsername() {
        let newName = $('#new-username-input').val().trim();
        if (newName) {
            username = newName;
            localStorage.setItem('simulatorUsername', username);
            updateDisplay();
            closeModal('settings-modal');
        } else {
            alert("Username cannot be empty.");
        }
    }

    function showModal(id) {
        document.getElementById(id).style.display = "block";
        if (id === 'leaderboard-modal') {
            fetchLeaderboard(); // Fetch the latest scores when the modal opens
        }
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    // Initial setup
    $(document).ready(function() {
        updateDisplay();
        $('#new-username-input').val(username); // Pre-fill settings input
    });
</script>

</body>
</html>
