<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arcade Hub</title>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; display: flex; flex-direction: column; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; width: 90%; max-width: 800px; margin-top: 20px; }
        .card { background: #1e293b; padding: 20px; border-radius: 10px; text-align: center; cursor: pointer; border: 1px solid #334155; transition: 0.2s; }
        .card:hover { transform: translateY(-5px); border-color: #3b82f6; }
        h1 { margin-top: 40px; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; flex-direction: column; }
        button { padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ARCADE HUB</h1>
    <p id="username">Loading...</p>

    <div class="grid">
        <div class="card" onclick="findMatch('connect4')">üî¥ Connect 4</div>
        <div class="card" onclick="findMatch('battleship')">üö¢ Battleship</div>
        <div class="card" onclick="findMatch('tanks')">üöú Tanks (Top Down)</div>
        <div class="card" onclick="findMatch('knockout')">üêß Knockout</div>
        <div class="card" onclick="findMatch('paintball')">üî´ Paintball</div>
    </div>

    <div id="overlay">
        <h2 id="status">Searching...</h2>
        <button onclick="location.reload()">Cancel</button>
    </div>

    <script type="module">
        import { db } from './config.js';
        import { ref, set, onValue, remove, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        let myId = localStorage.getItem("playerId");
        if (!myId) { myId = "user_" + Math.random().toString(36).substr(2, 5); localStorage.setItem("playerId", myId); }
        document.getElementById('username').innerText = "Player: " + myId;

        // Reset current match on load
        update(ref(db, 'players/' + myId), { currentMatch: null });

        window.findMatch = function(game) {
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('status').innerText = "Looking for " + game + "...";

            const queueRef = ref(db, 'queue/' + game);
            onValue(queueRef, (snapshot) => {
                const queue = snapshot.val();
                if (queue) {
                    const enemyId = Object.keys(queue)[0];
                    if (enemyId !== myId) {
                        const matchId = "m_" + Date.now();
                        remove(ref(db, 'queue/' + game + '/' + enemyId));
                        set(ref(db, 'games/' + matchId), { p1: enemyId, p2: myId, turn: enemyId, state: "init" });
                        update(ref(db, 'players/' + enemyId), { currentMatch: matchId });
                        update(ref(db, 'players/' + myId), { currentMatch: matchId });
                        return;
                    }
                }
                set(ref(db, 'queue/' + game + '/' + myId), { t: Date.now() });
                onDisconnect(ref(db, 'queue/' + game + '/' + myId)).remove();
            }, { onlyOnce: true });
        };

        onValue(ref(db, 'players/' + myId + '/currentMatch'), (snap) => {
            if (snap.val()) {
                const gameType = document.getElementById('status').innerText.split(" ")[2].toLowerCase().replace("...", "");
                // Redirect based on what we were searching for
                // Simple hack: check text, or just store gameType in localStorage
                // For now, let's assume the user remembers what they clicked
                // Better way:
                const statusText = document.getElementById('status').innerText;
                if(statusText.includes("Connect")) location.href = "connect4.html?m=" + snap.val();
                if(statusText.includes("Battleship")) location.href = "battleship.html?m=" + snap.val();
                if(statusText.includes("Tanks")) location.href = "tanks.html?m=" + snap.val();
                if(statusText.includes("Knockout")) location.href = "knockout.html?m=" + snap.val();
                if(statusText.includes("Paintball")) location.href = "paintball.html?m=" + snap.val();
            }
        });
    </script>
</body>
</html>
