<!DOCTYPE html>
<html>
<head>
    <title>Knockout</title>
    <style>body { margin:0; background: #006994; overflow: hidden; }</style>
</head>
<body>
    <canvas id="game"></canvas>
    <script type="module">
        import { db } from './config.js';
        import { ref, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        
        const matchId = new URLSearchParams(location.search).get('m');
        const myId = localStorage.getItem("playerId");

        let players = {};
        let myP = { x: 300, y: 300, vx: 0, vy: 0 };
        
        // Input
        let dragStart = null;
        window.onmousedown = e => dragStart = { x: e.clientX, y: e.clientY };
        window.onmouseup = e => {
            if(!dragStart) return;
            let dx = dragStart.x - e.clientX;
            let dy = dragStart.y - e.clientY;
            myP.vx += dx * 0.1; 
            myP.vy += dy * 0.1;
            dragStart = null;
        };

        // Loop
        setInterval(() => {
            // Physics
            myP.x += myP.vx; myP.y += myP.vy;
            myP.vx *= 0.98; myP.vy *= 0.98; // Friction

            // Bounds (Iceberg)
            let dist = Math.sqrt((myP.x - canvas.width/2)**2 + (myP.y - canvas.height/2)**2);
            if(dist > 300) { 
                // Fell off
                myP.x = canvas.width/2; myP.y = canvas.height/2; myP.vx = 0; myP.vy = 0;
            }

            // Send to DB
            update(ref(db, 'games/' + matchId + '/players/' + myId), myP);

        }, 30);

        onValue(ref(db, 'games/' + matchId + '/players'), snap => {
            players = snap.val() || {};
        });

        function draw() {
            ctx.fillStyle = "#006994"; ctx.fillRect(0,0,canvas.width, canvas.height);
            
            // Iceberg
            ctx.fillStyle = "#e0f7fa"; ctx.beginPath(); 
            ctx.arc(canvas.width/2, canvas.height/2, 300, 0, Math.PI*2); ctx.fill();

            // Players
            for(let id in players) {
                let p = players[id];
                ctx.fillStyle = (id === myId) ? "black" : "red";
                ctx.beginPath(); ctx.arc(p.x, p.y, 20, 0, Math.PI*2); ctx.fill();
            }
            requestAnimationFrame(draw);
        }
        draw();
    </script>
</body>
</html>
