<!DOCTYPE html>
<html>
<head>
    <title>Battleship</title>
    <style>
        body { background: #0f172a; color: white; text-align: center; font-family: sans-serif; }
        .container { display: flex; justify-content: center; gap: 20px; }
        .grid { display: grid; grid-template-columns: repeat(10, 30px); gap: 2px; }
        .cell { width: 30px; height: 30px; background: #1e293b; border: 1px solid #334155; cursor: pointer; }
        .ship { background: gray; } .hit { background: red; } .miss { background: white; }
    </style>
</head>
<body>
    <h2 id="msg">Place your ships (Click 5 spots)</h2>
    <div class="container">
        <div><h3>MY FLEET</h3><div id="myBoard" class="grid"></div></div>
        <div><h3>RADAR</h3><div id="enemyBoard" class="grid"></div></div>
    </div>
    <button onclick="location.href='index.html'" style="margin-top:20px">Exit</button>

    <script type="module">
        import { db } from './config.js';
        import { ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const matchId = new URLSearchParams(location.search).get('m');
        const myId = localStorage.getItem("playerId");
        let myShips = [], myShots = [], enemyShots = [], state = 'setup';

        // Init Grids
        for(let i=0; i<100; i++) {
            let c1 = document.createElement('div'); c1.className = 'cell'; c1.id = 'my-'+i;
            c1.onclick = () => placeShip(i);
            document.getElementById('myBoard').appendChild(c1);
            
            let c2 = document.createElement('div'); c2.className = 'cell'; c2.id = 'en-'+i;
            c2.onclick = () => shoot(i);
            document.getElementById('enemyBoard').appendChild(c2);
        }

        function placeShip(i) {
            if(state !== 'setup' || myShips.length >= 5 || myShips.includes(i)) return;
            myShips.push(i);
            document.getElementById('my-'+i).classList.add('ship');
            if(myShips.length === 5) {
                state = 'ready';
                document.getElementById('msg').innerText = "Waiting for opponent...";
                update(ref(db, 'games/' + matchId + '/' + myId), { ready: true, ships: myShips });
            }
        }

        function shoot(i) {
            if(state !== 'playing' || myShots.includes(i)) return;
            // Send shot to DB
            update(ref(db, 'games/' + matchId), { lastShot: { p: myId, idx: i } });
        }

        onValue(ref(db, 'games/' + matchId), (snap) => {
            const data = snap.val();
            if(!data) return;

            // Check if both ready
            if(data[data.p1]?.ready && data[data.p2]?.ready && state !== 'playing') {
                state = 'playing';
                document.getElementById('msg').innerText = "GAME START! Click Radar to shoot.";
            }

            // Handle Shots
            if(data.lastShot && data.lastShot.p !== myId) {
                // Enemy shot at ME
                let idx = data.lastShot.idx;
                let hit = myShips.includes(idx);
                document.getElementById('my-'+idx).className = 'cell ' + (hit ? 'hit' : 'miss');
                // You should update the DB here to say if it was a hit/miss so the enemy can see
                // For simplicity, we assume we just visually update locally
            }
        });
    </script>
</body>
</html>
