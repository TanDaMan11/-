<!DOCTYPE html>
<html>
<head>
    <title>Smash Arena</title>
    <style>
        body { margin: 0; background: #111; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; }
        
        /* UI LAYERS */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #menu { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; color: white;
        }
        
        /* CARDS */
        .card-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .card { 
            border: 2px solid #444; background: #222; padding: 20px; width: 140px; 
            text-align: center; cursor: pointer; border-radius: 8px; transition: 0.1s;
        }
        .card:hover { transform: scale(1.05); border-color: white; }
        .selected { border-color: #0f0; background: #002200; box-shadow: 0 0 10px #0f0; }
        
        button { 
            padding: 15px 50px; font-size: 24px; background: #d00; color: white; border: none; 
            cursor: pointer; font-weight: bold; border-radius: 5px;
        }
        button:hover { background: #f00; }

        /* HUD */
        #hud { display: none; padding: 20px; color: white; }
        .hp-box { width: 300px; height: 20px; border: 2px solid white; background: #333; }
        .hp-fill { height: 100%; width: 100%; background: #0f0; transition: width 0.1s; }
    </style>
</head>
<body>

    <div id="menu">
        <h1 style="font-size:60px; margin:0; color: #ff0055;">SUPER SMASH ARENA</h1>
        <p id="status">Connecting...</p>
        
        <div class="card-row">
            <div class="card selected" onclick="setWep('gun', this)">
                <h2>ðŸ”«</h2><b>Rifle</b><br><small>Range</small>
            </div>
            <div class="card" onclick="setWep('shotgun', this)">
                <h2>ðŸ’¥</h2><b>Shotgun</b><br><small>Burst</small>
            </div>
            <div class="card" onclick="setWep('axe', this)">
                <h2>ðŸª“</h2><b>Axe</b><br><small>Heavy</small>
            </div>
        </div>
        <button onclick="startGame()">READY TO FIGHT</button>
    </div>

    <div id="ui-layer">
        <div id="hud">
            <h2 id="kills">Kills: 0</h2>
            <div class="hp-box"><div id="hp" class="hp-fill"></div></div>
        </div>
    </div>

    <canvas id="game"></canvas>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // --- 1. SETUP ---
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const socket = io('https://8o2lymxge7.onrender.com');

        // Game State
        let myId = null;
        let players = {};
        let myWep = 'gun';
        let camera = {x:0, y:0};
        
        // Physics
        const MAP_W = 2500, MAP_H = 1000;
        let pos = {x:100, y:0, vx:0, vy:0, grounded:false};
        const keys = {w:false, a:false, s:false, d:false};
        let mouse = {x:0, y:0, angle:0};

        // Resize
        function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
        window.onresize = resize; resize();

        // --- 2. MENU LOGIC ---
        function setWep(w, el) {
            myWep = w;
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        function startGame() {
            if(!myId) return alert("Still connecting... please wait 2 seconds.");
            document.getElementById('menu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            
            // THE CRITICAL LINE: FORCE THE JOIN
            socket.emit('joinGame', myWep);
        }

        socket.on('connect', () => { 
            myId = socket.id; 
            document.getElementById('status').innerText = "Connected! Select Weapon:";
        });
        
        socket.on('playerCount', c => {
            if(document.getElementById('menu').style.display !== 'none') {
                document.getElementById('status').innerText = c + " Fighters Online";
            }
        });

        // --- 3. INPUTS ---
        window.onkeydown = e => keys[e.key.toLowerCase()] = true;
        window.onkeyup = e => keys[e.key.toLowerCase()] = false;
        window.onmousemove = e => {
            mouse.angle = Math.atan2(e.clientY - canvas.height/2, e.clientX - canvas.width/2);
        };
        window.onmousedown = () => socket.emit('attack', {type:'primary', angle:mouse.angle});

        let lastSpecial = 0;
        function checkSpecial() {
            if(keys.s && Date.now() - lastSpecial > 1500) {
                lastSpecial = Date.now();
                socket.emit('attack', {type:'special', angle:mouse.angle});
                // Axe Slam Logic
                if(myWep === 'axe' && !pos.grounded) pos.vy = 25; 
            }
        }

        // --- 4. GAME LOOP ---
        const platforms = [
            {x:0, y:MAP_H-50, w:MAP_W, h:50}, // Floor
            {x:400, y:700, w:400, h:20},      // Plat 1
            {x:1200, y:600, w:500, h:20},     // Plat 2
            {x:2000, y:500, w:300, h:20},     // Plat 3
            {x:900, y:400, w:200, h:20}       // High Plat
        ];

        let fx = [];

        function update() {
            // Only update physics if I am actually playing
            if(myId && players[myId] && players[myId].active) {
                
                // Move
                pos.vx = 0;
                if(keys.a) pos.vx = -10;
                if(keys.d) pos.vx = 10;
                
                // Jump (Snappy)
                if(keys.w && pos.grounded) { pos.vy = -20; pos.grounded = false; }
                
                checkSpecial();

                // Gravity
                pos.vy += 0.9;
                pos.x += pos.vx;
                pos.y += pos.vy;

                // Bounds
                if(pos.x < 0) pos.x = 0;
                if(pos.x > MAP_W) pos.x = MAP_W;

                // Collision
                pos.grounded = false;
                for(let p of platforms) {
                    if(pos.vy >= 0
